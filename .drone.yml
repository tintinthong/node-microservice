kind: pipeline
name: default

steps:
- name: start-notify
  image: plugins/slack
  settings:
    webhook: https://hooks.slack.com/services/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
    channel: cicd
    template: >
        Build {{build.number}} of {{build.branch}} started. {{build.link}}
- name: build
  image: node:9.8.0
  commands:
  - sh ./.drone/build.sh
#- name: publish docker 
#  image: plugins/docker
#  settings:
#    username:
#      from_secret: docker_username
#    password:
#      from_secret: docker_password
#    repo: tintinthong/whatever
steps:
- name: publish  
  image: plugins/gcr
  settings:
    registry: asia.gcr.io
    repo: drone-251904/drone 
    tags: latest
    json_key: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiZHJvbmUtMjUxOTA0IiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiZjk1YTg5YWI1YmI5NDE3MzQxOTg2ZTcwODYxNDE5YWEwNDg3NWE4MyIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZnSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2d3Z2dTa0FnRUFBb0lCQVFEQk9QZ3E1WjVMZDZTcFxuQUExcWhoS0tCa2JLSDJyUVl1MzR1dlBDMTBKME1CV3plZU15VFJzYURVZkpDa2ZkV1ZOQzB1Zm5aNUdRblZ4U1xuTTlyTm9GQjd3TGsrclNQanRDa2JrZWpnVis5aWsyd0NoTVJUR082QUttTXhYNUlVdm5PSzN2WkZjN0pxRCtoOVxuVmxRWHhIYmdjL1Vwemc1UEpYNkUwYlk4NmJCd0g1dVY5TnJhYWgzdTF4WmpGRWJybU5PdnkyR1JnbWZoSkRXTFxuR1dtdFRaRTJkcU0zb3BiMEQzNzRJeVhNVXcxallzei9kbm5UYjQwcTdvQnUxQ1RicW96d2xkakdoa2puRHVwQlxudG91NnVocTRncWpTRVRBMmV6eHRwSkU3bmczMkxRVXBCaFBrSkJjSTlTUkh5eURYUG83MkZNbkczWWFuQXlWWVxuU3ZKRUlqTlhBZ01CQUFFQ2dnRUFBd2tueFFJWjRaVDkrUFhFNnR2ZVpnZ1dpL2hyRDRrWkNnNWpPV0xKRllBOVxuUEdENWlTeHk5T1FwTU9jV0hVdlkrMTkxbGZUU1J2NWg3cHl5bndadmNwejROc2JnOHlQbjBzUzd4RUtTd3Bsa1xuV2duSFRUTHRhYkFXSWpiSkx4cnE2bm41bytVSnlaRjV2L1pmbUlhcXJpTnU3UHJpemdBekk2MFQwRDNhV3MzdFxuVXZranRESFZrVjBlOThmb1Z3NTloUHZWcy9OSXhrWDhFTmplTjgwQmsyZzZESzZvZk9yLzZSQ25iUW14U3ppUVxuc0tmamVQRkVjRXBrWS90TjZTSUhFNlVlVXBjMlZkcDUwVkFXNXJ2WHEya2YzWm5KT2pqazZQZmdrbVVXd2NLdFxuMTQycllLZkJWaDA2ZjJUelN2dVFkZGt5MlJ1L004a04rb0ltRGRWd01RS0JnUURzcDErSk4rUUhaWVZiNXpLNFxuemxFNEdrLzBzSXZGM1k1eGRHZmVtZ09HT1RZRTVjMC9lall6eFdoR0J0alk5VkozTnRseU8wME9KS3VrZHJHZlxuTlVRK2Zrb0k1eDVtOVhCSFJJeVZQc0hLMlVMUy9WaG5Ycm1ja2JSK1ZkMi81SjB1bmhib09JeHk1MENYdXVtUlxuMjF4ZjJHdEk3cDRJQUl4bzRtdkNmQU93K1FLQmdRRFJCSzJ1ZEUvSUFUdkVYdEt3dzlFenlpOXNtY2IzSjBmeFxuOWM4SHpSOGFZbE5tZkJiYWNNYndMNFgxK2IzcDhuTWsxU1k5QWZLVkxkV2dkSVhWTHhOTDlYQXp1ZVYweUJCQlxudngwbG1kNWExTnU4bjFxdWZKQmRMZDd6UVNuWmdGY0FnSjBQRktUOGJQc1d5OVpkaGp5bjdXNVN4ZDRmWUxQS1xuYUw3NWE1ZHF6d0tCZ1FDcWpmWE1idnRvV1VKRGVkeVVWQjAwMGNIT0YyNmtxNGg5TytlZ0JsK0QzTGVSMEF5Y1xuTXZmZFYraE9qNkM0dkJVeTFkVGcvdHdKMVdQZW82eGZrWVFkaGViVmc3dmxkLzN6WHZQeW04Z082WVcvaWRhc1xucVJnY1B1WldKb3dxUUJrSC8rZUNkVDdEa09aOGM3amg1Yll0WFV2MHhBUWd3RVJ4VXIxVzdRbThBUUtCZ0N6MlxuaHE0cWt5Y0JMT3czUWJlSXlDNE41bG5FVXNyRUJuUUVYcjdjM3ozN3ZOa2xCSDJGR1NaOThxRlJVZ3RMZm4yRFxuNUsvbkJWb1YvQWlDU0cvdHFvY0NpMXAxT09rQVNJNzhIN2NBL0pZcGlBTnhmRDVneVdWaUFyM3RYS1ZQT0dnQlxuUXNnRnR1QWVTWDFENkI5Q1N6WU1tMWp1KzdOZ1NBellyNHhVR3NSOUFvR0JBSm9vTDhydjBHL0NIOStJMHVyQVxuWmFNaE9aOHA2RGpUTkdpeTVDcUFSSkkrVGdxaHdlSTRKcVRTUm9rdDBaUkVSOXJlRDNUQWRacHcvamFHUHQ1YlxuRWVicW5TRXh0bWUzRnNCcWhxRmFrU0o5SCsrZ01kcE5EZGs3eFdjRDFRZXkxOXE2c3VSTHlVanROSG00eU1WRlxubFJaQzRWMnBwR0NQbFIrUDdISkZlK21PXG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiMTA0NzQ2NzU0ODQ5NS1jb21wdXRlQGRldmVsb3Blci5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExMzE0OTk5NjE3NjY4NDU5ODczNCIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvMTA0NzQ2NzU0ODQ5NS1jb21wdXRlJTQwZGV2ZWxvcGVyLmdzZXJ2aWNlYWNjb3VudC5jb20iCn0K
- name: deploy
  image: docker
  commands:
  - sh ./.drone/deploy.sh
  volumes:
  - name: docker
    path: /var/run/docker.sock
- name: end-notify
  image: plugins/slack
  settings:
    webhook: https://hooks.slack.com/services/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
    channel: cicd
    template: >
      {{#success build.status}}
        Build {{build.number}} of {{build.branch}} successful. {{build.link}}
      {{else}}
        Build {{build.number}} of {{build.branch}} failed. Please fix!. {{build.link}}
      {{/success}}
volumes:
- name: docker
  host:
    path: /var/run/docker.sock
